---
import Layout from '../../layouts/Layout.astro'
import type { CategoryContributor, CategoryCount, LinkData } from '../../types'

const { category } = Astro.params

const top_links_resp = await fetch(
	`http://127.0.0.1:8000/links/cat/${category}`
)
const top_links: LinkData[] = await top_links_resp.json()
// [{URL: 'https://example.com', LikeCount: 100}, ...]

let subcats: CategoryCount[]
let top_contributors: CategoryContributor[]

if (!top_links || top_links.length === 0) {
	return Astro.redirect('/404')
} else {
	const subcats_resp = await fetch(
		`http://127.0.0.1:8000/links/subcat/${category}`
	)
	subcats = await subcats_resp.json()
	// [{Category: 'flowers', Count: 2}, ...]

	const top_contributors_resp = await fetch(
		`http://127.0.0.1:8000/links/cat/${category}/users`
	)
	top_contributors = await top_contributors_resp.json()
	// [{"Categories":"umvc3,2dfighters","LoginName":"bob","LinksSubmitted":"10"}]
}
---

<Layout title='Welcome to the Open Internet Treasure Map (OITM)'>
	<main>
		<h1>{category}</h1>
		{subcats.length ? <h2>Subcategories</h2> : null}
		{
			subcats.length ? (
				<ul>
					{subcats.map((subcat) => (
						<li>
							<a href={`/cat/${category},${subcat.Category}`}>
								{subcat.Category}
							</a>
							: <span>({subcat.Count})</span>
						</li>
					))}
				</ul>
			) : (
				<p>No further subcategories</p>
			)
		}
		<h2>Top Links</h2>
		<ul>
			{
				top_links.map((link) => (
					<li>
						<a href={link.URL}>{link.URL}</a>: ({link.LikeCount})
					</li>
				))
			}
		</ul>
		<h2>Top Contributors</h2>
		<ul>
			{
				top_contributors.map((contributor: CategoryContributor) => (
					<li>
						<strong>
							<a href={`/map/${contributor.LoginName}`}>
								{contributor.LoginName}
							</a>
						</strong>
						<span>: ({contributor.LinksSubmitted})</span>
					</li>
				))
			}
		</ul>
	</main>
</Layout>

<style></style>
